"""
P√°gina de Analytics e Predi√ß√µes de Desempenho
"""

import streamlit as st
import json
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
from datetime import datetime, timedelta
import sys
import os

# Adicionar o diret√≥rio raiz ao path
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from app.utils.performance_predictor import PerformancePredictor
from tools.recommendation_tool import RecommendationTool

def render_analytics_page():
    """Renderiza a p√°gina de analytics e predi√ß√µes"""
    
    st.title("üìä Analytics e Predi√ß√µes de Desempenho")
    st.markdown("An√°lise avan√ßada do seu progresso e predi√ß√µes baseadas em IA")
    
    # Carregar dados do usu√°rio
    user_data = _load_user_data()
    
    # Inicializar ferramentas
    predictor = PerformancePredictor()
    recommender = RecommendationTool()
    
    # Tabs principais
    tab1, tab2, tab3, tab4 = st.tabs([
        "üéØ Predi√ß√£o de Desempenho", 
        "üí° Recomenda√ß√µes IA", 
        "üìà An√°lise Detalhada",
        "üîÆ Simula√ß√£o de Cen√°rios"
    ])
    
    with tab1:
        render_performance_prediction(predictor, user_data)
    
    with tab2:
        render_ai_recommendations(recommender, user_data)
    
    with tab3:
        render_detailed_analysis(predictor, user_data)
    
    with tab4:
        render_scenario_simulation(predictor, user_data)

def render_performance_prediction(predictor, user_data):
    """Renderiza predi√ß√µes de desempenho"""
    
    st.subheader("üéØ Predi√ß√£o de Desempenho na Prova")
    
    # Configura√ß√µes da predi√ß√£o
    col1, col2, col3 = st.columns(3)
    
    with col1:
        target_banca = st.selectbox(
            "Banca do Concurso",
            ["CESPE", "FCC", "VUNESP", "FGV", "IBFC"],
            index=0
        )
    
    with col2:
        days_until_exam = st.number_input(
            "Dias at√© a Prova",
            min_value=1,
            max_value=365,
            value=90
        )
    
    with col3:
        if st.button("üîÆ Gerar Predi√ß√£o", use_container_width=True):
            st.session_state.prediction_generated = True
    
    if st.session_state.get('prediction_generated', False):
        with st.spinner("ü§ñ Analisando dados e gerando predi√ß√£o..."):
            # Gerar predi√ß√£o
            prediction = predictor.predict_exam_performance(
                user_data, target_banca, days_until_exam
            )
            
            # Exibir resultado principal
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric(
                    "üìä Pontua√ß√£o Prevista",
                    f"{prediction.predicted_score:.1f}%",
                    delta=f"Confian√ßa: {prediction.confidence:.0f}%"
                )
            
            with col2:
                improvement = prediction.improvement_potential
                st.metric(
                    "üìà Potencial de Melhoria",
                    f"{improvement:.1f}%",
                    delta="Com estudo focado"
                )
            
            with col3:
                # Determinar status baseado na pontua√ß√£o
                if prediction.predicted_score >= 80:
                    status = "üåü Excelente"
                    color = "green"
                elif prediction.predicted_score >= 70:
                    status = "‚úÖ Aprov√°vel"
                    color = "blue"
                elif prediction.predicted_score >= 60:
                    status = "‚ö†Ô∏è Lim√≠trofe"
                    color = "orange"
                else:
                    status = "üö® Risco"
                    color = "red"
                
                st.metric("üéØ Status", status)
            
            # Gr√°fico de distribui√ß√£o de probabilidades
            st.subheader("üìä Distribui√ß√£o de Probabilidades")
            
            prob_data = prediction.probability_ranges
            ranges = list(prob_data.keys())
            probabilities = [prob_data[r] * 100 for r in ranges]
            
            fig = px.bar(
                x=ranges,
                y=probabilities,
                title="Probabilidade por Faixa de Pontua√ß√£o",
                labels={'x': 'Faixa de Pontua√ß√£o (%)', 'y': 'Probabilidade (%)'},
                color=probabilities,
                color_continuous_scale='RdYlGn'
            )
            fig.update_layout(showlegend=False)
            st.plotly_chart(fig, use_container_width=True)
            
            # Recomenda√ß√µes da predi√ß√£o
            if prediction.recommendations:
                st.subheader("üí° Recomenda√ß√µes Baseadas na Predi√ß√£o")
                for i, rec in enumerate(prediction.recommendations, 1):
                    st.markdown(f"**{i}.** {rec}")
            
            # Fatores de risco
            if prediction.risk_factors:
                st.subheader("‚ö†Ô∏è Fatores de Risco Identificados")
                for risk in prediction.risk_factors:
                    st.warning(risk)

def render_ai_recommendations(recommender, user_data):
    """Renderiza recomenda√ß√µes da IA"""
    
    st.subheader("üí° Recomenda√ß√µes Personalizadas por IA")
    
    # Gerar recomenda√ß√µes
    with st.spinner("ü§ñ Analisando seu perfil e gerando recomenda√ß√µes..."):
        try:
            recommendations_json = recommender._run(
                "generate_recommendations",
                json.dumps({"user_data": user_data})
            )
            recommendations = json.loads(recommendations_json)
            
            if "error" in recommendations:
                st.error(f"Erro ao gerar recomenda√ß√µes: {recommendations['error']}")
                return
            
            # Filtrar por categoria
            categories = {
                "üéØ Foco de Estudo": [r for r in recommendations if r['type'] == 'study_focus'],
                "‚è∞ Cronograma": [r for r in recommendations if r['type'] == 'schedule'],
                "üß† T√©cnicas": [r for r in recommendations if r['type'] == 'technique'],
                "üí™ Motiva√ß√£o": [r for r in recommendations if r['type'] == 'motivation'],
                "üìö Materiais": [r for r in recommendations if r['type'] == 'material']
            }
            
            # Exibir por categoria
            for category, recs in categories.items():
                if recs:
                    st.markdown(f"### {category}")
                    
                    for rec in recs:
                        # Cor baseada na prioridade
                        if rec['priority'] == 'high':
                            priority_color = "üî¥"
                        elif rec['priority'] == 'medium':
                            priority_color = "üü°"
                        else:
                            priority_color = "üü¢"
                        
                        with st.expander(f"{priority_color} {rec['title']} (Confian√ßa: {rec['confidence']:.0%})"):
                            st.write(f"**Descri√ß√£o:** {rec['description']}")
                            st.write(f"**A√ß√£o:** {rec['action']}")
                            st.write(f"**Impacto Estimado:** {rec['estimated_impact']}")
                            
                            # Tags
                            if rec['tags']:
                                st.write("**Tags:** " + " ‚Ä¢ ".join([f"`{tag}`" for tag in rec['tags']]))
            
            # Dicas r√°pidas
            st.markdown("### ‚ö° Dicas R√°pidas")
            
            user_level = _determine_user_level(user_data)
            tips_json = recommender._run("get_quick_tips", json.dumps({"user_level": user_level}))
            tips = json.loads(tips_json)
            
            for tip in tips:
                st.info(tip['tip'])
                
        except Exception as e:
            st.error(f"Erro ao carregar recomenda√ß√µes: {str(e)}")

def render_detailed_analysis(predictor, user_data):
    """Renderiza an√°lise detalhada"""
    
    st.subheader("üìà An√°lise Detalhada de Desempenho")
    
    # Analisar m√©tricas atuais
    metrics = predictor.analyze_performance(user_data)
    
    # M√©tricas principais
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("üìä Pontua√ß√£o Geral", f"{metrics.overall_score:.1f}%")
    
    with col2:
        st.metric("üéØ Consist√™ncia", f"{metrics.consistency_score:.1f}%")
    
    with col3:
        trend_emoji = "üìà" if metrics.improvement_rate > 0 else "üìâ" if metrics.improvement_rate < 0 else "‚û°Ô∏è"
        st.metric("üìà Taxa de Melhoria", f"{metrics.improvement_rate:.1f}", delta=trend_emoji)
    
    with col4:
        st.metric("‚ö° Efici√™ncia", f"{metrics.study_efficiency:.1f}")
    
    # An√°lise por mat√©ria
    st.subheader("üìö Desempenho por Mat√©ria")
    
    if metrics.subject_scores:
        # Criar DataFrame para visualiza√ß√£o
        subject_df = pd.DataFrame([
            {
                'Mat√©ria': subject,
                'Pontua√ß√£o': score,
                'Status': 'Forte' if score >= 80 else 'M√©dio' if score >= 60 else 'Fraco'
            }
            for subject, score in metrics.subject_scores.items()
        ])
        
        # Gr√°fico de barras
        fig = px.bar(
            subject_df,
            x='Mat√©ria',
            y='Pontua√ß√£o',
            color='Status',
            color_discrete_map={'Forte': 'green', 'M√©dio': 'orange', 'Fraco': 'red'},
            title="Pontua√ß√£o por Mat√©ria"
        )
        fig.add_hline(y=60, line_dash="dash", line_color="red", annotation_text="Linha de Aprova√ß√£o")
        fig.add_hline(y=80, line_dash="dash", line_color="green", annotation_text="Excel√™ncia")
        st.plotly_chart(fig, use_container_width=True)
    
    # √Åreas de aten√ß√£o
    col1, col2 = st.columns(2)
    
    with col1:
        if metrics.weak_areas:
            st.subheader("‚ö†Ô∏è √Åreas que Precisam de Aten√ß√£o")
            for area in metrics.weak_areas:
                st.error(f"üìâ {area}")
        else:
            st.success("‚úÖ Nenhuma √°rea cr√≠tica identificada!")
    
    with col2:
        if metrics.strong_areas:
            st.subheader("üåü Suas √Åreas Fortes")
            for area in metrics.strong_areas:
                st.success(f"üí™ {area}")
        else:
            st.info("Continue estudando para desenvolver √°reas fortes!")

def render_scenario_simulation(predictor, user_data):
    """Renderiza simula√ß√£o de cen√°rios"""
    
    st.subheader("üîÆ Simula√ß√£o de Cen√°rios")
    st.markdown("Veja como diferentes estrat√©gias podem afetar seu desempenho")
    
    # Configura√ß√µes do cen√°rio
    st.markdown("### ‚öôÔ∏è Configurar Cen√°rio")
    
    col1, col2 = st.columns(2)
    
    with col1:
        extra_hours = st.slider(
            "Horas extras de estudo por semana",
            min_value=0,
            max_value=20,
            value=0,
            step=2
        )
        
        focus_subject = st.selectbox(
            "Mat√©ria de foco extra",
            ["Nenhuma"] + list(user_data.get('subject_progress', {}).keys())
        )
    
    with col2:
        study_intensity = st.selectbox(
            "Intensidade de estudo",
            ["Normal", "Intensiva", "M√°xima"]
        )
        
        technique_improvement = st.slider(
            "Melhoria nas t√©cnicas de estudo (%)",
            min_value=0,
            max_value=50,
            value=0,
            step=5
        )
    
    if st.button("üöÄ Simular Cen√°rio", use_container_width=True):
        with st.spinner("üîÑ Simulando cen√°rio..."):
            # Simular modifica√ß√µes nos dados
            modified_data = user_data.copy()
            
            # Aplicar modifica√ß√µes
            current_hours = modified_data.get('total_study_hours', 40)
            modified_data['total_study_hours'] = current_hours + (extra_hours * 4)  # 4 semanas
            
            # Simular melhoria na mat√©ria de foco
            if focus_subject != "Nenhuma" and 'subject_progress' in modified_data:
                if focus_subject in modified_data['subject_progress']:
                    current_score = modified_data['subject_progress'][focus_subject].get('last_score', 60)
                    improvement = min(15, extra_hours * 2)  # M√°ximo 15 pontos de melhoria
                    modified_data['subject_progress'][focus_subject]['last_score'] = min(100, current_score + improvement)
            
            # Aplicar melhoria geral baseada na intensidade
            intensity_multiplier = {'Normal': 1.0, 'Intensiva': 1.2, 'M√°xima': 1.5}
            multiplier = intensity_multiplier[study_intensity]
            
            # Simular melhoria geral
            if 'mock_exam_scores' in modified_data:
                for exam in modified_data['mock_exam_scores']:
                    base_improvement = technique_improvement / 100
                    exam['score'] = min(100, exam['score'] * (1 + base_improvement * multiplier))
            
            # Gerar predi√ß√µes para cen√°rio original e modificado
            original_prediction = predictor.predict_exam_performance(user_data, "CESPE", 90)
            scenario_prediction = predictor.predict_exam_performance(modified_data, "CESPE", 90)
            
            # Comparar resultados
            st.markdown("### üìä Compara√ß√£o de Resultados")
            
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric(
                    "üìä Cen√°rio Atual",
                    f"{original_prediction.predicted_score:.1f}%"
                )
            
            with col2:
                improvement = scenario_prediction.predicted_score - original_prediction.predicted_score
                st.metric(
                    "üöÄ Cen√°rio Simulado",
                    f"{scenario_prediction.predicted_score:.1f}%",
                    delta=f"+{improvement:.1f}%"
                )
            
            with col3:
                confidence_change = scenario_prediction.confidence - original_prediction.confidence
                st.metric(
                    "üéØ Mudan√ßa na Confian√ßa",
                    f"{scenario_prediction.confidence:.0f}%",
                    delta=f"{confidence_change:+.0f}%"
                )
            
            # Gr√°fico de compara√ß√£o
            comparison_data = {
                'Cen√°rio': ['Atual', 'Simulado'],
                'Pontua√ß√£o': [original_prediction.predicted_score, scenario_prediction.predicted_score],
                'Confian√ßa': [original_prediction.confidence, scenario_prediction.confidence]
            }
            
            fig = go.Figure()
            fig.add_trace(go.Bar(
                name='Pontua√ß√£o Prevista',
                x=comparison_data['Cen√°rio'],
                y=comparison_data['Pontua√ß√£o'],
                yaxis='y',
                offsetgroup=1
            ))
            fig.add_trace(go.Bar(
                name='Confian√ßa',
                x=comparison_data['Cen√°rio'],
                y=comparison_data['Confian√ßa'],
                yaxis='y2',
                offsetgroup=2
            ))
            
            fig.update_layout(
                title='Compara√ß√£o: Atual vs Cen√°rio Simulado',
                xaxis_title='Cen√°rio',
                yaxis=dict(title='Pontua√ß√£o (%)', side='left'),
                yaxis2=dict(title='Confian√ßa (%)', side='right', overlaying='y'),
                barmode='group'
            )
            
            st.plotly_chart(fig, use_container_width=True)
            
            # Insights do cen√°rio
            if improvement > 5:
                st.success(f"üéâ Excelente! Este cen√°rio pode melhorar sua pontua√ß√£o em {improvement:.1f} pontos!")
            elif improvement > 0:
                st.info(f"üìà Melhoria moderada de {improvement:.1f} pontos com esta estrat√©gia.")
            else:
                st.warning("‚ö†Ô∏è Este cen√°rio n√£o mostra melhoria significativa. Considere outras estrat√©gias.")

def _load_user_data():
    """Carrega dados do usu√°rio para an√°lise"""
    try:
        with open("data/dashboard/dashboard_data.json", "r", encoding='utf-8') as f:
            return json.load(f)
    except:
        # Dados de fallback
        return {
            "total_study_hours": 80,
            "simulados_completed": 3,
            "average_score": 72,
            "consistency_score": 75,
            "current_streak": 12,
            "subject_progress": {
                "Portugu√™s": {"last_score": 78},
                "Matem√°tica": {"last_score": 65},
                "Direito": {"last_score": 82},
                "Inform√°tica": {"last_score": 85}
            },
            "mock_exam_scores": [
                {"date": "2024-01-01", "score": 65},
                {"date": "2024-01-08", "score": 70},
                {"date": "2024-01-15", "score": 75}
            ]
        }

def _determine_user_level(user_data):
    """Determina o n√≠vel do usu√°rio baseado nos dados"""
    study_hours = user_data.get('total_study_hours', 0)
    average_score = user_data.get('average_score', 0)
    
    if study_hours < 20 or average_score < 50:
        return 'beginner'
    elif study_hours < 100 or average_score < 75:
        return 'intermediate'
    else:
        return 'advanced'
